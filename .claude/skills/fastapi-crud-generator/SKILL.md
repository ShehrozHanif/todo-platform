---
name: fastapi-crud-generator
description: |
  Generate FastAPI CRUD REST endpoints with Pydantic schemas, error handling, and integration tests.
  This skill should be used when users ask to create REST API endpoints, FastAPI routes,
  CRUD operations, or API layers for Python web backends.
---

# FastAPI CRUD Generator

Generate **production-quality REST API endpoints** for FastAPI with Pydantic request/response schemas, proper HTTP status codes, error handling, and comprehensive integration tests using httpx AsyncClient.

## What This Skill Does

- Creates FastAPI route handlers for CRUD operations (GET, POST, PUT, DELETE, PATCH)
- Generates Pydantic v2 request/response schemas with validation
- Produces FastAPI app factory with CORS, lifespan, and router wiring
- Provides httpx AsyncClient integration test patterns with dependency overrides
- Encodes proper HTTP status codes and error taxonomy

## What This Skill Does NOT Do

- Create database models or connections (see `neon-sqlmodel-generator`)
- Handle authentication or JWT middleware (see `better-auth-jwt-generator`)
- Generate frontend code or UI components
- Deploy or containerize the API
- Implement WebSocket or GraphQL endpoints

---

## Before Implementation

Gather context to ensure successful implementation:

| Source | Gather |
|--------|--------|
| **Codebase** | Existing `backend/models.py`, `backend/db.py`, project structure |
| **Conversation** | User's specific endpoints, resource names, business rules |
| **Skill References** | FastAPI patterns from `references/fastapi-patterns.md`, error handling from `references/error-handling.md` |
| **User Guidelines** | Project constitution, AGENTS.md conventions, task IDs |

**Prerequisite:** `neon-sqlmodel-generator` must be completed first — this skill imports from `backend/models.py` and `backend/db.py`.

---

## Implementation Steps

Execute in this exact order. Write tests FIRST (RED), then implementation (GREEN).

### Phase 1: Schemas

1. Create `backend/schemas/` directory with `__init__.py`
2. Write Pydantic schemas in `backend/schemas/task.py` — see [templates/pydantic-schemas.md](templates/pydantic-schemas.md)
3. Schemas are pure Pydantic (no table=True), used for request/response validation

### Phase 2: Route Handlers (RED → GREEN)

1. Write integration tests in `backend/tests/test_routes.py` — see [templates/test-patterns.md](templates/test-patterns.md)
   - Test each of 6 endpoints: happy path + error cases
   - Use httpx AsyncClient with app dependency override
   - ~25-30 tests total
2. Update test fixtures in `backend/tests/conftest.py` — see [templates/test-fixtures.md](templates/test-fixtures.md)
   - Add `client` fixture with dependency override for `get_session`
   - Add `seed_user` and `seed_task` helper fixtures
3. Create `backend/routes/` directory with `__init__.py`
4. Implement route handlers in `backend/routes/tasks.py` — see [templates/route-handlers.md](templates/route-handlers.md)
5. Run `uv run pytest -v` — verify all route tests pass

### Phase 3: App Factory

1. Implement `backend/main.py` — see [templates/app-factory.md](templates/app-factory.md)
   - CORSMiddleware with configurable origins
   - Lifespan from `db.py`
   - Include task router with `/api` prefix
   - Health check endpoint at `/health`
2. Run `uv run pytest -v` — verify ALL tests pass (models + routes)

### Phase 4: Final Verification

1. Run `uv run pytest --cov=backend --cov-report=term-missing`
2. Verify 90%+ coverage on routes and schemas
3. Verify all HTTP status codes match spec

---

## API Endpoint Specification

| Method | Path | Status | Request Body | Response |
|--------|------|--------|--------------|----------|
| GET | `/api/{user_id}/tasks` | 200 | — | `list[TaskResponse]` |
| POST | `/api/{user_id}/tasks` | 201 | `TaskCreate` | `TaskResponse` |
| GET | `/api/{user_id}/tasks/{id}` | 200 | — | `TaskResponse` |
| PUT | `/api/{user_id}/tasks/{id}` | 200 | `TaskUpdate` | `TaskResponse` |
| DELETE | `/api/{user_id}/tasks/{id}` | 204 | — | — |
| PATCH | `/api/{user_id}/tasks/{id}/complete` | 200 | — | `TaskResponse` |

### Error Responses

| Status | When | Response Body |
|--------|------|---------------|
| 400 | Empty title, invalid input | `{"detail": "Title cannot be empty"}` |
| 404 | Task or user not found | `{"detail": "Task not found"}` |
| 422 | Pydantic validation failure | Auto-generated by FastAPI |

---

## Key Design Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Schema separation | Separate Pydantic models from SQLModel tables | Clean API contract; DB models stay internal |
| Async everywhere | All handlers are `async def` | Matches async DB layer from Feature 1 |
| Dependency injection | `session: AsyncSession = Depends(get_session)` | Testable, overridable, auto-cleanup |
| user_id in path | `/api/{user_id}/tasks` | Pre-auth pattern; auth middleware validates later |
| DELETE returns 204 | No response body | HTTP standard for successful deletion |
| PATCH for toggle | `/complete` sub-resource | Semantic — PATCH modifies a single field |
| Test strategy | httpx AsyncClient + dep override | Official FastAPI testing pattern |

---

## Critical Invariants

- All route handlers are `async def` — no sync DB calls
- Every handler receives `session` via `Depends(get_session)`
- `user_id` is `str` in path parameters (Better Auth compatibility)
- Task `id` is `int` in path parameters
- POST returns 201, DELETE returns 204, everything else returns 200
- 404 raised when task not found OR task doesn't belong to user_id
- Schemas use `model_config = {"from_attributes": True}` for SQLModel conversion
- Tests override `get_session` dependency — never hit real DB
- CORS origins come from environment variable, not hardcoded

---

## Output Specification

| File | Purpose | Template |
|------|---------|----------|
| `backend/schemas/task.py` | Pydantic request/response schemas | [templates/pydantic-schemas.md](templates/pydantic-schemas.md) |
| `backend/routes/tasks.py` | 6 CRUD route handlers | [templates/route-handlers.md](templates/route-handlers.md) |
| `backend/main.py` | FastAPI app factory with CORS + lifespan | [templates/app-factory.md](templates/app-factory.md) |
| `backend/tests/conftest.py` | Updated fixtures with client + seed helpers | [templates/test-fixtures.md](templates/test-fixtures.md) |
| `backend/tests/test_routes.py` | ~25-30 integration tests | [templates/test-patterns.md](templates/test-patterns.md) |

---

## Domain Standards

### Must Follow
- [ ] All handlers `async def` with `Depends(get_session)`
- [ ] Pydantic schemas separate from SQLModel table models
- [ ] `from_attributes = True` in response schema config
- [ ] Proper HTTP status codes (201 create, 204 delete, 404 not found)
- [ ] Task ownership: every query filters by `user_id`
- [ ] CORS origins from `ALLOWED_ORIGINS` env var

### Must Avoid
- Returning 200 for POST creation (must be 201)
- Returning response body for DELETE (must be 204 No Content)
- Sync database operations inside async handlers
- Hardcoded CORS origins
- Missing `user_id` filter (data leaking between users)
- Catching broad exceptions instead of specific HTTPException

---

## Output Checklist

Before delivering, verify:
- [ ] `backend/schemas/task.py` — TaskCreate, TaskUpdate, TaskResponse schemas
- [ ] `backend/routes/tasks.py` — All 6 endpoints with correct status codes
- [ ] `backend/main.py` — App factory with CORS, lifespan, router, health check
- [ ] `backend/tests/conftest.py` — client fixture with dep override, seed helpers
- [ ] `backend/tests/test_routes.py` — 25+ tests covering happy + error paths
- [ ] All tests use dependency override (no real DB)
- [ ] Coverage ≥ 90% on routes/ and schemas/
- [ ] Every file has Task ID comment referencing specs
- [ ] No hardcoded secrets, origins, or connection strings

---

## Reference Files

| File | When to Read |
|------|--------------|
| `references/fastapi-patterns.md` | Router setup, dependency injection, async handlers |
| `references/error-handling.md` | HTTPException patterns, status codes, error taxonomy |
| `templates/pydantic-schemas.md` | Exact schema code template |
| `templates/route-handlers.md` | Exact route handler code template |
| `templates/app-factory.md` | Exact main.py code template |
| `templates/test-fixtures.md` | Updated conftest.py with client fixtures |
| `templates/test-patterns.md` | Integration test examples for all 6 endpoints |
